# PNG Encoder Regression Analysis - Issue #96

## CRITICAL FINDINGS

### PNG Structure Corruption
**Status**: SYSTEMATIC FAILURE - ALL PNG files generated by fortplot are malformed

**Root Cause**: Invalid row-filter type (255) in PNG IDAT chunks
- **Expected**: Row filter type 0 (no filter) 
- **Actual**: Row filter type 255 (invalid/private)
- **Impact**: PIL/Python cannot read PNG files ("bad adaptive filter value" error)

### Validation Results
```
pngcheck validation: FAIL
- Every row has invalid filter type (255)
- Hundreds of warnings per PNG file
- Files structurally invalid according to PNG specification
```

### PIL/Python Compatibility
```
PIL.Image.open(): FAIL
- "unrecognized data stream contents" error
- "bad adaptive filter value" error  
- Complete incompatibility with Python/PIL ecosystem
```

## TECHNICAL ANALYSIS

### Expected PNG Row Structure
```fortran
! From src/fortplot_raster.f90:403
buffer(row_start) = 0_1  ! PNG filter byte: 0 = no filter
```

### Actual PNG Row Structure
```
pngcheck output: private (invalid?) row-filter type (255)
```

### Problem Location
The PNG encoder correctly sets filter bytes to `0_1` but somewhere in the compression/encoding pipeline, these bytes are being corrupted to `255`.

**Likely corruption points:**
1. `fortplot_zlib.f90` - DEFLATE compression corrupting filter bytes
2. `fortplot_png.f90` - PNG chunk generation/CRC calculation
3. Signed/unsigned byte conversion errors in filter byte handling

## CI INTEGRATION FRAMEWORK

### New Test: `test/test_png_validation.f90`
- **pngcheck integration**: Validates PNG structure integrity
- **PIL compatibility check**: Tests Python ecosystem compatibility
- **Automated failure detection**: Returns non-zero exit code on validation failure
- **Ready for CI**: Framework complete, waiting for encoder fix

### CI Integration Plan
```yaml
# Add to .github/workflows/ci.yml
- name: Install pngcheck
  run: sudo apt-get install -y pngcheck

- name: PNG Validation Tests  
  run: make test ARGS="test_png_validation"
```

## IMMEDIATE ACTIONS REQUIRED

### Priority 1: Fix PNG Encoder
- **Target**: `src/fortplot_zlib.f90` and `src/fortplot_png.f90`
- **Focus**: Row filter byte corruption during compression
- **Goal**: Generate PNG files with valid filter type 0

### Priority 2: Enable CI Validation
- **Add pngcheck to CI dependencies**
- **Enable PNG validation test in CI pipeline**  
- **Block merges until PNG validation passes**

### Priority 3: Comprehensive Testing
- **Test all PNG output formats**
- **Validate with multiple PNG readers**
- **Performance regression testing**

## TEST VERIFICATION

### Current Test Status
```bash
make test ARGS="test_png_validation"
# Result: FAIL - demonstrates PNG encoder regression
# Framework: READY for production use once encoder fixed
```

### Manual Validation Commands
```bash
# Validate any PNG file
pngcheck -v <file.png>

# Quick validation (quiet mode)
pngcheck -q <file.png>

# Test PIL compatibility
python3 -c "from PIL import Image; Image.open('<file.png>')"
```

## REGRESSION IMPACT

**Severity**: CRITICAL
- **All PNG output is malformed**
- **Complete Python/PIL incompatibility**  
- **PNG files fail industry-standard validation tools**
- **May affect other PNG readers (browsers, image editors, etc.)**

**User Impact**: 
- PNG files appear to work in some viewers but fail in Python ecosystem
- Data analysis workflows broken for users relying on PIL/matplotlib
- Scientific reproducibility compromised

## NEXT STEPS

1. **sergei-perfectionist-coder**: Fix PNG encoder in `src/fortplot_zlib.f90`
2. **max-devops-engineer**: Add pngcheck to CI pipeline after fix
3. **Team**: Comprehensive PNG validation testing across all output formats